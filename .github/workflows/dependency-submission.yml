name: Submit Dependency Snapshots

on:
  pull_request:
    branches: [main]
    paths:
      - "Packages/*.pkl"

env:
  PKL_VERSION: 0.26.3
  PKL_ARCH: macos-aarch64
  GITHUB_API_URL: https://api.github.com/repos/willswire/cosmic/dependency-graph/snapshots

jobs:
  submit-dependencies:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - name: Install pkl
        run: |
          curl -L -o pkl "https://github.com/apple/pkl/releases/download/${PKL_VERSION}/pkl-${PKL_ARCH}"
          chmod +x pkl
          sudo mv pkl /usr/local/bin/pkl
          pkl --version

      - name: Evaluate PKL files
        id: eval-pkl
        run: |
          for FILE in $(find Packages -type f -name '*.pkl' ! -name '.*'); do
            pkl eval -f json $FILE > Packages/$(basename ${FILE%.pkl}.json)
          done

      - name: Submit Dependency Snapshot to GitHub
        run: |
          sha=$(git rev-parse HEAD)
          timestamp=$(date +'%Y-%m-%dT%H:%M:%SZ')

          for JSON_FILE in $(find Packages -type f -name '*.json'); do
            curl -L \
              -X POST \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              $GITHUB_API_URL \
              -d "{
                \"version\": 0,
                \"sha\": \"${sha}\",
                \"ref\": \"refs/heads/main\",
                \"job\": {
                  \"correlator\": \"submit-dependencies\",
                  \"id\": \"${{ github.run_id }}\"
                },
                \"detector\": {
                  \"name\": \"pkl-detector\",
                  \"version\": \"${PKL_VERSION}\",
                  \"url\": \"https://github.com/apple/pkl\"
                },
                \"scanned\": \"${timestamp}\",
                \"manifests\": {
                  \"$(basename $JSON_FILE)\": {
                    \"name\": \"$(basename $JSON_FILE)\",
                    \"file\": {
                      \"source_location\": \"$JSON_FILE\"
                    }
                  }
                }
              }"
          done
